Scope (MVP)
Musí být (MVP)
Nové entity v DB pro nákupy (Purchase Orders) a jejich položky

Statusy nákupu:

draft (nákupní seznam)

ordered (potvrzeno / na cestě)

partially_received

received (vše dorazilo)

cancelled

Příjem zboží (Receive):

pro každou PO položku lze přijmout množství (i po částech)

při příjmu se automaticky vytvoří:

InventoryTransaction (direction IN / reason purchase)

u lotovaných položek vznikne nový lot nebo se doplní existující (podle UI volby)

UI:

Shopping List panel + možnost „Convert to Purchase / Mark as Ordered“

Stránka „Purchases“ (seznam nákupů + filtry podle statusu)

Detail nákupu: položky, stav objednáno vs. přijato, tlačítko „Receive“

„Receive modal“ (po položkách nebo hromadně)

Napojení na existující low-stock:

když je item low-stock, uživatel ho přidá do shopping listu

při vytvoření PO se to promítne do “on the way” (přehled)

Bezpečnost/permissions:

čtení: inventory.read

zápis: inventory.write

Mimo MVP (ale připravit rozumně)
kalkulace hodnoty skladů v Kč

integrace s dodavateli (Supplier entity)

import/scan faktur, automatické párování

automatické odpisy dle feeding/medical (to je jiný epic)

Datový model (návrh)
Claude: přizpůsob existujícím patterns (SQLAlchemy, Alembic, Pydantic schemas).

Tabulka: purchase_orders
id UUID PK

organization_id UUID (FK, index)

status enum (draft, ordered, partially_received, received, cancelled)

title / name (string) – např. „Nákup 2026-02-19“

notes (text, nullable)

created_by_user_id UUID (nullable)

ordered_at datetime nullable

expected_at date/datetime nullable

received_at datetime nullable (když vše complete)

created_at, updated_at

Tabulka: purchase_order_items
id UUID PK

purchase_order_id UUID FK (index)

inventory_item_id UUID FK (index)

unit (optional) – pro MVP nepřepisovat, použij unit z inventory_item

quantity_ordered numeric (např. NUMERIC(10,2))

quantity_received numeric default 0

notes (nullable)

created_at, updated_at

Tabulka: purchase_receipts (MVP může být i bez, ale doporučeno kvůli audit trailu)
id UUID PK

purchase_order_id UUID FK (index)

received_by_user_id UUID nullable

received_at datetime

notes nullable

Tabulka: purchase_receipt_items
id UUID PK

purchase_receipt_id UUID FK (index)

purchase_order_item_id UUID FK

inventory_item_id UUID FK

quantity_received numeric

lot_id UUID nullable (pokud lotovaný item)

expires_at date nullable (pokud se zakládá nový lot)

created_at

Pozn.: pokud je to na MVP moc, lze purchase_receipts sloučit do jednoho endpointu, ale minimálně quantity_received per PO item musí existovat.

Integrace s existujícím Inventory
Základní pravidla
Inventory “stock movement” je pořád zdroj pravdy: InventoryTransaction.

Nákup pouze řídí workflow a odkládá moment příjmu.

Při příjmu vytvoříme transakci typu:

direction = IN

reason = PURCHASE (nebo existující enum/field)

inventory_item_id

quantity

lot_id (pokud existuje)

created_by_user_id

Loty (expirace)
Pokud item podporuje loty/expiraci:

v Receive UI musí uživatel vybrat:

„Add to existing lot“ (select lot)

nebo „Create new lot“ (enter lot_number? + expires_at)

Pokud item loty nemá:

lot_id = null, jen transakce + navýšení stavů.

API (návrh endpointů)
Přizpůsob routing konvencím projektu.

Purchase Orders
GET /purchases – list, filtry: status, date range, pagination

POST /purchases – create draft (nebo create directly ordered)

GET /purchases/{id} – detail

PATCH /purchases/{id} – update title/notes/status (omezeně)

POST /purchases/{id}/mark-ordered – přechod draft → ordered

POST /purchases/{id}/cancel – cancel (pokud není received)

Purchase Items
POST /purchases/{id}/items – add item (inventory_item_id, qty)

PATCH /purchases/{id}/items/{itemId} – update qty, notes

DELETE /purchases/{id}/items/{itemId} – remove (jen v draft)

Receive
POST /purchases/{id}/receive

body: list položek { purchase_order_item_id, quantity_received, lot_mode, lot_id?, expires_at?, lot_number? }

server:

transakční DB operace (atomic)

validace: received <= ordered - already_received

vytvoří InventoryTransaction (+ lot pokud potřebuje)

navýší quantity_received na PO item

status PO:

pokud vše received → received

pokud něco → partially_received

(volitelně) GET /purchases/{id}/receipts

UI / UX zadání
1) Shopping List Panel (existuje) – rozšíření
Přidat CTA tlačítko: “Create Purchase Order” / “Mark as Ordered”

Po potvrzení:

vytvoří se Purchase Order draft (nebo rovnou ordered – rozhodni pro MVP)

shopping list se buď:

vyprázdní

nebo se nabídne „ponechat položky“

U položek zobrazit:

on_hand (sklad)

on_the_way (součet qty_ordered - qty_received v ordered/partial PO)

aby uživatel viděl, že už je to objednané

2) Stránka: /dashboard/inventory/purchases
tabulka:

název, status badge, created_at, ordered_at, count items, progress (received/ordered)

filtry:

status

text search (title)

quick actions:

open detail

mark ordered (pokud draft)

cancel

3) Detail nákupu: /dashboard/inventory/purchases/[id]
nahoře: status + progress bar

tabulka položek:

item name, unit, qty ordered, qty received, qty remaining

pro lotované: indikace „requires lot/expiry“

CTA: Receive shipment

otevře modal:

pro každou položku input „received now“

validace max

pro lotované: volba existing lot / new lot (+ expirace)

submit → POST receive

4) Propojení s detailem itemu (volitelně)
na item detailu zobrazit:

„On the way“ součet z PO

link na relevantní purchases

Stavové přechody a pravidla
draft: lze editovat položky, mazat, měnit qty

ordered: položky už neměnit (MVP), jen receive / cancel (pokud 0 received)

partially_received: receive dál, cancel už jen s confirm (a zůstane rozpracované?) – pro MVP: dovol jen receive do completion

received: read-only

cancelled: read-only

Migrace & kompatibilita
Alembic migrace musí být bezpečná a nasaditelná na Railway.

Nezasahovat destruktivně do existujících inventory tabulek.

Vše nové tabulky a případné enumy přidat idempotentně.

Pokud existují patterns pro enums v DB, použít stejné.

Logging, audit, a perf
V receive endpointu:

logovat event (purchase received)

přidat request_id / perf tracing pokud už existuje middleware

transakce musí být atomic (když failne jedna položka, neuloží se nic)

Test scénáře (minimální)
Vytvoř draft nákup z shopping listu → obsahuje položky

Mark ordered → status ordered

Receive 1 položku částečně → status partially_received, transakce created

Receive zbytek → status received, součet received == ordered

Lotovaný item: receive vytvoří lot, transakce má lot_id

Low-stock item: po příjmu už není low-stock

Definice hotova (DoD)
API + DB migrační skripty projdou

Vercel build projde (web)

Railway deploy projde (api)

UI umožní celý flow: shopping list → purchase → ordered → receive → received

Inventory transakce i loty se správně vytvoří

Nezhorší se existující inventory screens

Chceš, aby MVP šel cestou:

A) Shopping List → vytvoří draft, a teprve na detailu klikneš „Mark ordered“

B) Shopping List → rovnou vytvoří ordered (nejrychlejší UX)

Když řekneš A/B, upravím zadání jednou větou do finální podoby (Claude to pak nebude řešit sám).