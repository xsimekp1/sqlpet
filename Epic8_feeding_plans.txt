EPIC: Feeding Plans 2.0 – sjednocené UX + rolling generování krmných úkolů (bez stovek tasků dopředu)
0) Kontext projektu (co už existuje – nebourat)
Backend (už je hotovo)

Modely:

FeedingPlan – krmný plán (animal, food, množství, časy, datum, aktivace)

FeedingLog – záznam o nakrmení

Food – definice krmiv (kcal, kategorie, jednotka atp.)

Služby:

CRUD krmných plánů (create/update/deactivate)

Logování krmení + automatický odečet ze skladu (FIFO)

Generování úkolů z rozvrhu (zatím ručně / částečně)

Dokončení krmného úkolu → FeedingLog + odečet

API:

POST/GET /feeding/plans

POST/GET /feeding/logs

POST /feeding/tasks/complete

POST /feeding/tasks/generate (ruční)

Integrace:

Odečet z inventory FIFO

Tasky s TaskType.FEEDING

Frontend (už je hotovo)

/feeding – přehled dneška

/feeding/plans – seznam plánů

/feeding/plans/new – vytvoření plánu

/feeding/plans/[id] – edit

MER kalkulačka

1) Problém / motivace

UX pro zadávání krmného plánu je zmatečné (frekvence, hodiny, víc kroků/oken).

Dlouhé období plánu (např. 6 měsíců × 2× denně) by znamenalo ~360 úkolů dopředu → nechceme plnit DB, komplikovat změny plánu, mazat/rekalkulovat stovky tasků.

2) Cíl MVP

Zjednodušit tvorbu a editaci krmných plánů (jedna obrazovka/sekce, přehledný rozvrh).

Přestat generovat tasky na celé období a zavést rolling window generování (např. 48h dopředu).

Zachovat stávající integraci: dokončení úkolu = log + odečet FIFO.

3) UX a UI: nové zadávání / editace FeedingPlan
3.1 Zásady

Ne “wizard”, ale jedna stránka/dialog se sekcemi, aby user viděl vše najednou.

Vždy zobrazit živý náhled (dnes + zítra).

Defaulty musí být chytré (šablony časů, rovnoměrné rozdělení dávky).

Přidat validace, aby šlo plán uložit bez edge-case chyb.

3.2 Screen: Create/Edit Feeding Plan

Použij existující routy:

/feeding/plans/new

/feeding/plans/[id]

Sekce A: Základ plánu

Pole:

Zvíře (pokud založeno z detailu, předvyplnit a zamknout; jinak select)

Krmivo (Food select)

Denní dávka (numerické pole + jednotka z krmiva/itemu)

Platnost:

start_date (povinné, default dnes)

end_date (volitelné) + toggle “do odvolání”

Poznámka/instrukce (volitelné)

Sekce B: Rozvrh (hlavní UX fix)

UI:

“Kolikrát denně” jako segmented control / dropdown: 1–6

Pod tím “Doporučené časy” – rychlé preset tlačítka:

1×: 08:00

2×: 08:00, 18:00

3×: 08:00, 13:00, 18:00

4×: 07:00, 12:00, 17:00, 21:00

5×: rozumně rozložit (např. 07:00, 10:30, 14:00, 17:30, 21:00)

6×: rozumně rozložit

Časy editovatelné inline pomocí time inputů, automaticky se:

sortí vzestupně

odstraňují duplicity (nebo validace “unikátní časy”)

Akce:

“+ Přidat čas”

“Reset na doporučené”

Sekce C: Rozdělení denní dávky na časy

Default:

“Rozdělit rovnoměrně” (auto on)
Volitelně:

toggle “Upravit ručně”

pro každý čas zobrazit množství

hlídat součet = denní dávka (nebo nabídnout “Přepočítat rovnoměrně”)

Sekce D: Náhled “Dnes / Zítra”

Pod plánem zobrazit mini přehled:

Dnes:

08:00 – 50 g

18:00 – 50 g

Zítra:

…
Tento náhled musí reflektovat:

start/end date

frekvenci a množství

4) Task generation: rolling window (best practice pro dlouhé plány)
4.1 Princip

Místo generování všech úkolů dopředu:

Generovat pouze úkoly v okně [now, now + horizon]

horizon pro MVP: 48 hodin

Hodnota konfigurovatelná env:

FEEDING_TASK_HORIZON_HOURS=48

4.2 Požadované chování

Uživatel na /feeding vždy vidí úkoly pro dnešek (a ideálně i zítřek).

Systém udržuje dopředu 48h úkolů, ale ne víc.

Generování musí být idempotentní (opakovaný běh nevytvoří duplicity).

5) Backend implementace (detail)
5.1 Data model (ověřit / případně doplnit)

Ujistit se, že FeedingPlan umí reprezentovat:

start_date, end_date (nullable)

times (array time / JSON list, např. ["08:00","18:00"])

amounts (array numeric, stejná délka jako times) – pokud dnes neexistuje, doplnit

active

Pozn.: Pokud je dnes dávka uložena jinak (např. per-time schedule), zachovat, ale API response musí umožnit frontendové sekce A–D.

5.2 Service: “ensure window”

Vytvořit/posílit metodu (název dle konvencí projektu):

ensure_feeding_tasks_window(organization_id, from_dt, to_dt)
Co dělá:

Načte aktivní FeedingPlan pro organizaci.

Pro každý plán spočítá “occurrences” v intervalu (respektuje start/end).

Pro každou occurrence vytvoří Task typu FEEDING, pokud neexistuje.

Idempotence / unikátní klíč (kritické)

Aby se netvořily duplicity:

Task musí obsahovat:

animal_id

source_plan_id (nové pole nebo již existující metadata)

scheduled_at (datetime)

type = FEEDING

Zajistit unique constraint (doporučeno):

unique index: (type, animal_id, source_plan_id, scheduled_at)

Pokud nechceme měnit DB indexy, musí service kontrolovat existenci před insert (ale index je robustnější).

5.3 Co při změně FeedingPlan

Při update plánu:

budoucí pending úkoly v rolling okně musí odpovídat novému rozvrhu
MVP pravidlo:

najít všechny FEEDING tasky v budoucnu v okně [now, now+horizon] pro source_plan_id

které nejsou completed

smazat je a znovu vygenerovat podle nového plánu

completed tasky se nemění

5.4 Scheduler (automatické doplňování)

Protože v projektu zatím “jen manuální generování”:

zavést pravidelný job, který 1× za X minut/hodinu zavolá ensure window.

MVP implementační strategie:

zachovat endpoint /feeding/tasks/generate a rozšířit ho:

aby uměl “ensure window” podle horizon

nebo přidat nový endpoint /feeding/tasks/ensure-window

Scheduler pak volá tento endpoint.

Pozn.: Implementaci scheduleru zvol podle stacku:

Pokud už máte Celery/beat → použít.

Pokud ne → použít platformní cron (Railway cron / Supabase cron / GitHub action) a volat endpoint.

5.5 Lazy fallback (když cron neproběhne)

Při načtení /feeding:

backend nebo frontend triggerne ensure window:

volání endpointu, který doplní úkoly na 48h dopředu

aby uživatel nikdy nepřišel na prázdný dnešek jen proto, že cron spadl.

6) Frontend implementace (detail)
6.1 Krmné plány UI

refaktor /feeding/plans/new a /feeding/plans/[id]:

implementovat sekce A–D

presets časů

rovnoměrné rozdělení + ruční override

náhled dnes/zítra

6.2 /feeding (Today)

při mountu:

zavolat ensure-window endpoint (lazy)

zobrazit:

dnešní úkoly (minimálně)

volitelně “zítra” sekci (doporučeno)

dokončení úkolu beze změny:

volá /feeding/tasks/complete

vzniká FeedingLog + odečet ze skladu (FIFO)

7) Edge cases (MVP pravidla)

Plán startuje v budoucnu → negenerovat před start_date

Plán má end_date v minulosti → negenerovat

Duplicita časů → validace + auto-normalize

Překročení/nesoučet dávek při ručním rozdělení → blok uložit + nabídka auto-fix

8) Acceptance criteria

Vytvoření a editace krmného plánu je přehledné na jedné obrazovce a obsahuje náhled “Dnes/Zítra”.

Pro dlouhý plán se nevytvoří stovky tasků, ale pouze rolling okno 48h.

Generování úkolů je idempotentní (žádné duplicity).

Existuje automatické doplňování (cron) + lazy fallback při otevření /feeding.

Změna plánu upraví budoucí pending tasky v rolling okně (delete + regenerate).

Dokončení tasku dál loguje FeedingLog a odečítá inventory FIFO (nezměněné chování).